<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>師生管理</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --purple: #7c3aed; --purple-light: #ede9fe; --text: #1a1a2e;
  --sub: #6b7280; --border: #e5e7eb; --bg: #f3f4f6; --white: #fff;
  --green: #10b981; --red: #ef4444; --blue: #3b82f6; --radius: 10px;
}
body { font-family: 'Noto Sans TC', sans-serif; background: var(--bg); color: var(--text); padding: 20px; }

/* Tabs */
.tabs { display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 2px solid var(--border); }
.tab { padding: 10px 20px; font-size: 14px; font-weight: 500; color: var(--sub); cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px; transition: all .2s; }
.tab.active { color: var(--purple); border-bottom-color: var(--purple); }
.tab-pane { display: none; }
.tab-pane.active { display: block; }

/* Stats */
.stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px; }
.stat-card { background: white; border-radius: var(--radius); padding: 20px; border: 1px solid var(--border); }
.stat-label { font-size: 13px; color: var(--sub); margin-bottom: 6px; }
.stat-value { font-size: 28px; font-weight: 700; color: var(--purple); }

/* Table */
.table-wrap { background: white; border-radius: var(--radius); border: 1px solid var(--border); overflow: hidden; margin-bottom: 20px; }
.table-wrap table { width: 100%; border-collapse: collapse; }
.table-wrap th { background: #f9fafb; padding: 12px 16px; text-align: left; font-size: 12px; color: var(--sub); font-weight: 600; border-bottom: 1px solid var(--border); white-space: nowrap; }
.table-wrap td { padding: 14px 16px; font-size: 13px; border-bottom: 1px solid #f3f4f6; }
.table-wrap tr:last-child td { border-bottom: none; }
.table-wrap tr:hover td { background: #fafafa; }

/* Buttons */
.btn { padding: 8px 16px; border-radius: 6px; font-size: 13px; font-weight: 500; cursor: pointer; border: none; font-family: inherit; transition: all .15s; }
.btn-primary { background: var(--purple); color: white; }
.btn-primary:hover { background: #6d28d9; }
.btn-success { background: var(--green); color: white; }
.btn-success:hover { background: #059669; }
.btn-danger { background: var(--red); color: white; }
.btn-danger:hover { background: #dc2626; }
.btn-secondary { background: var(--sub); color: white; }
.btn-sm { padding: 4px 12px; font-size: 12px; }

/* Form */
.form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
.form-group { display: flex; flex-direction: column; gap: 6px; }
.form-group.full { grid-column: 1/-1; }
.form-label { font-size: 13px; font-weight: 500; color: var(--sub); }
.form-input { padding: 10px 12px; border: 1px solid var(--border); border-radius: var(--radius); font-size: 14px; font-family: inherit; }
.form-input:focus { outline: none; border-color: var(--purple); }
.form-select { padding: 10px 12px; border: 1px solid var(--border); border-radius: var(--radius); font-size: 14px; font-family: inherit; }

/* Modal */
.modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
.modal.show { display: flex; }
.modal-content { background: white; border-radius: 12px; padding: 24px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.modal-title { font-size: 18px; font-weight: 700; }
.modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--sub); }
.modal-footer { display: flex; gap: 10px; justify-content: flex-end; margin-top: 24px; }

/* Badge */
.badge { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; }
.badge-active { background: #d1fae5; color: #065f46; }
.badge-inactive { background: #fee2e2; color: #991b1b; }

/* Filter */
.filter-bar { display: flex; gap: 10px; margin-bottom: 18px; align-items: center; flex-wrap: wrap; }
.search-input { flex: 1; min-width: 200px; padding: 8px 14px; border: 1px solid var(--border); border-radius: var(--radius); font-size: 14px; }
.search-input:focus { outline: none; border-color: var(--purple); }

.empty { text-align: center; padding: 40px; color: var(--sub); }
</style>
</head>
<body>

<div class="tabs">
  <div class="tab active" onclick="switchTab('students')">學生管理</div>
  <div class="tab" onclick="switchTab('teachers')">教師管理</div>
</div>

<!-- Students Tab -->
<div class="tab-pane active" id="tab-students">
  <div class="stats">
    <div class="stat-card">
      <div class="stat-label">在學學生</div>
      <div class="stat-value" id="activeStudents">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">總學生數</div>
      <div class="stat-value" id="totalStudents">0</div>
    </div>
  </div>

  <div class="filter-bar">
    <input class="search-input" id="searchStudent" placeholder="搜尋學生姓名、聯絡方式..." oninput="renderStudents()">
    <button class="btn btn-primary" onclick="showAddStudentModal()">新增學生</button>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>學生編號</th>
          <th>姓名</th>
          <th>年齡</th>
          <th>聯絡方式</th>
          <th>學習項目</th>
          <th>程度</th>
          <th>家長</th>
          <th>報名日期</th>
          <th>狀態</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody id="studentTbody"></tbody>
    </table>
  </div>
</div>

<!-- Teachers Tab -->
<div class="tab-pane" id="tab-teachers">
  <div class="stats">
    <div class="stat-card">
      <div class="stat-label">在職教師</div>
      <div class="stat-value" id="activeTeachers">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">總教師數</div>
      <div class="stat-value" id="totalTeachers">0</div>
    </div>
  </div>

  <div class="filter-bar">
    <input class="search-input" id="searchTeacher" placeholder="搜尋教師姓名、科目..." oninput="renderTeachers()">
    <button class="btn btn-primary" onclick="showAddTeacherModal()">新增教師</button>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>姓名</th>
          <th>教學科目</th>
          <th>簡介</th>
          <th>時薪</th>
          <th>狀態</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody id="teacherTbody"></tbody>
    </table>
  </div>
</div>

<!-- Student Modal -->
<div class="modal" id="studentModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title" id="studentModalTitle">新增學生</div>
      <button class="modal-close" onclick="closeStudentModal()">&times;</button>
    </div>
    <form id="studentForm" onsubmit="saveStudent(event)">
      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">姓名 *</label>
          <input class="form-input" name="name" required>
        </div>
        <div class="form-group">
          <label class="form-label">年齡</label>
          <input class="form-input" name="age" type="number">
        </div>
        <div class="form-group">
          <label class="form-label">聯絡電話 *</label>
          <input class="form-input" name="contact" required>
        </div>
        <div class="form-group">
          <label class="form-label">Email</label>
          <input class="form-input" name="email" type="email">
        </div>
        <div class="form-group">
          <label class="form-label">學習項目</label>
          <input class="form-input" name="instrument" placeholder="如：鋼琴、吉他">
        </div>
        <div class="form-group">
          <label class="form-label">程度</label>
          <select class="form-select" name="level">
            <option value="">請選擇</option>
            <option value="初學者">初學者</option>
            <option value="有基礎">有基礎</option>
            <option value="進階">進階</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">家長姓名</label>
          <input class="form-input" name="parent_name">
        </div>
        <div class="form-group">
          <label class="form-label">家長聯絡方式</label>
          <input class="form-input" name="parent_contact">
        </div>
        <div class="form-group full">
          <label class="form-label">地址</label>
          <input class="form-input" name="address">
        </div>
        <div class="form-group full">
          <label class="form-label">備註</label>
          <textarea class="form-input" name="note" rows="3"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeStudentModal()">取消</button>
        <button type="submit" class="btn btn-primary">儲存</button>
      </div>
    </form>
  </div>
</div>

<!-- Teacher Modal -->
<div class="modal" id="teacherModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">新增教師</div>
      <button class="modal-close" onclick="closeTeacherModal()">&times;</button>
    </div>
    <form id="teacherForm" onsubmit="saveTeacher(event)">
      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">姓名 *</label>
          <input class="form-input" name="name" required>
        </div>
        <div class="form-group">
          <label class="form-label">教學科目 *</label>
          <input class="form-input" name="instrument" required>
        </div>
        <div class="form-group full">
          <label class="form-label">簡介 *</label>
          <textarea class="form-input" name="bio" rows="3" required></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">時薪（NT$）*</label>
          <input class="form-input" name="hourly_rate" type="number" required>
        </div>
        <div class="form-group">
          <label class="form-label">上課時間</label>
          <input class="form-input" name="times" placeholder="10:00,14:00,16:00">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeTeacherModal()">取消</button>
        <button type="submit" class="btn btn-primary">儲存</button>
      </div>
    </form>
  </div>
</div>

<script>
const API = '';
const pw = sessionStorage.getItem('adminPassword') || '';
let students = [];
let teachers = [];
let editingStudentId = null;

// Load Data
async function loadData() {
  await loadStudents();
  await loadTeachers();
}

async function loadStudents() {
  const res = await fetch(`${API}/admin/api/students`, { headers: { 'X-Admin-Password': pw } });
  students = await res.json();
  renderStudents();
  updateStudentStats();
}

async function loadTeachers() {
  const res = await fetch(`${API}/admin/api/teachers`, { headers: { 'X-Admin-Password': pw } });
  teachers = await res.json();
  renderTeachers();
  updateTeacherStats();
}

// Students
function renderStudents() {
  const q = document.getElementById('searchStudent').value.toLowerCase();
  let data = students.filter(s => 
    s.name.toLowerCase().includes(q) || 
    s.contact.toLowerCase().includes(q) ||
    s.student_id.toLowerCase().includes(q)
  );

  const tbody = document.getElementById('studentTbody');
  if (!data.length) {
    tbody.innerHTML = '<tr><td colspan="10" class="empty">沒有學生資料</td></tr>';
    return;
  }

  tbody.innerHTML = data.map(s => `
    <tr>
      <td><code>${s.student_id}</code></td>
      <td><strong>${s.name}</strong></td>
      <td>${s.age || '-'}</td>
      <td>${s.contact}</td>
      <td>${s.instrument || '-'}</td>
      <td>${s.level || '-'}</td>
      <td>${s.parent_name || '-'}<br><span style="font-size:11px;color:var(--sub)">${s.parent_contact || ''}</span></td>
      <td>${s.enrollment_date}</td>
      <td><span class="badge badge-${s.is_active?'active':'inactive'}">${s.is_active?'在學':'停學'}</span></td>
      <td>
        <button class="btn btn-sm btn-primary" onclick="editStudent(${s.id})">編輯</button>
        ${s.is_active ? `<button class="btn btn-sm btn-danger" onclick="deleteStudent(${s.id})">停學</button>` : ''}
      </td>
    </tr>
  `).join('');
}

function updateStudentStats() {
  document.getElementById('activeStudents').textContent = students.filter(s => s.is_active).length;
  document.getElementById('totalStudents').textContent = students.length;
}

function showAddStudentModal() {
  editingStudentId = null;
  document.getElementById('studentModalTitle').textContent = '新增學生';
  document.getElementById('studentForm').reset();
  document.getElementById('studentModal').classList.add('show');
}

function editStudent(id) {
  const student = students.find(s => s.id === id);
  if (!student) return;

  editingStudentId = id;
  document.getElementById('studentModalTitle').textContent = '編輯學生';
  
  const form = document.getElementById('studentForm');
  form.name.value = student.name;
  form.age.value = student.age || '';
  form.contact.value = student.contact;
  form.email.value = student.email || '';
  form.instrument.value = student.instrument || '';
  form.level.value = student.level || '';
  form.parent_name.value = student.parent_name || '';
  form.parent_contact.value = student.parent_contact || '';
  form.address.value = student.address || '';
  form.note.value = student.note || '';
  
  document.getElementById('studentModal').classList.add('show');
}

async function saveStudent(e) {
  e.preventDefault();
  const form = e.target;
  const data = {
    name: form.name.value,
    age: form.age.value ? parseInt(form.age.value) : null,
    contact: form.contact.value,
    email: form.email.value,
    instrument: form.instrument.value,
    level: form.level.value,
    parent_name: form.parent_name.value,
    parent_contact: form.parent_contact.value,
    address: form.address.value,
    note: form.note.value,
  };

  const url = editingStudentId 
    ? `${API}/admin/api/students/${editingStudentId}`
    : `${API}/admin/api/students`;
  const method = editingStudentId ? 'PUT' : 'POST';

  const res = await fetch(url, {
    method,
    headers: { 'Content-Type': 'application/json', 'X-Admin-Password': pw },
    body: JSON.stringify(data)
  });

  if (res.ok) {
    closeStudentModal();
    await loadStudents();
    alert(editingStudentId ? '學生資料已更新' : '學生已新增');
  } else {
    alert('操作失敗');
  }
}

async function deleteStudent(id) {
  if (!confirm('確定要將此學生設為停學？')) return;
  const res = await fetch(`${API}/admin/api/students/${id}`, {
    method: 'DELETE',
    headers: { 'X-Admin-Password': pw }
  });
  if (res.ok) {
    await loadStudents();
  }
}

function closeStudentModal() {
  document.getElementById('studentModal').classList.remove('show');
}

// Teachers
function renderTeachers() {
  const q = document.getElementById('searchTeacher').value.toLowerCase();
  let data = teachers.filter(t =>
    t.name.toLowerCase().includes(q) ||
    t.instrument.toLowerCase().includes(q)
  );

  const tbody = document.getElementById('teacherTbody');
  if (!data.length) {
    tbody.innerHTML = '<tr><td colspan="6" class="empty">沒有教師資料</td></tr>';
    return;
  }

  tbody.innerHTML = data.map(t => `
    <tr>
      <td><strong>${t.name}</strong></td>
      <td>${t.instrument}</td>
      <td style="max-width:300px">${t.bio}</td>
      <td>NT$ ${t.hourly_rate}</td>
      <td><span class="badge badge-active">在職</span></td>
      <td>
        <button class="btn btn-sm btn-danger" onclick="deleteTeacher(${t.id})">停用</button>
      </td>
    </tr>
  `).join('');
}

function updateTeacherStats() {
  document.getElementById('activeTeachers').textContent = teachers.length;
  document.getElementById('totalTeachers').textContent = teachers.length;
}

function showAddTeacherModal() {
  document.getElementById('teacherForm').reset();
  document.getElementById('teacherModal').classList.add('show');
}

async function saveTeacher(e) {
  e.preventDefault();
  const form = e.target;
  const data = {
    name: form.name.value,
    instrument: form.instrument.value,
    bio: form.bio.value,
    hourly_rate: parseInt(form.hourly_rate.value),
    times: form.times.value.split(',').map(t => t.trim()).filter(t => t)
  };

  const res = await fetch(`${API}/admin/api/teachers`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'X-Admin-Password': pw },
    body: JSON.stringify(data)
  });

  if (res.ok) {
    closeTeacherModal();
    await loadTeachers();
    alert('教師已新增');
  } else {
    alert('操作失敗');
  }
}

async function deleteTeacher(id) {
  if (!confirm('確定要停用此教師？')) return;
  const res = await fetch(`${API}/admin/api/teachers/${id}`, {
    method: 'DELETE',
    headers: { 'X-Admin-Password': pw }
  });
  if (res.ok) {
    await loadTeachers();
  }
}

function closeTeacherModal() {
  document.getElementById('teacherModal').classList.remove('show');
}

// Tab Switch
function switchTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById(`tab-${tab}`).classList.add('active');
}

// Init
loadData();
</script>

</body>
</html>