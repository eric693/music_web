<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LINE 訊息推播</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --purple: #7c3aed; --purple-light: #ede9fe; --text: #1a1a2e;
  --sub: #6b7280; --border: #e5e7eb; --bg: #f3f4f6; --white: #fff;
  --green: #10b981; --red: #ef4444; --line: #06c755; --radius: 10px;
}
body { font-family: 'Noto Sans TC', sans-serif; background: var(--bg); color: var(--text); padding: 20px; }

.header { margin-bottom: 24px; }
.header h2 { font-size: 24px; font-weight: 700; margin-bottom: 8px; }
.header p { font-size: 14px; color: var(--sub); }

/* Alert Box */
.alert { background: #fef3c7; border: 1px solid #fbbf24; border-radius: var(--radius); padding: 16px; margin-bottom: 24px; }
.alert-title { font-size: 14px; font-weight: 600; color: #92400e; margin-bottom: 4px; }
.alert-text { font-size: 13px; color: #78350f; line-height: 1.6; }

/* Stats */
.stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
.stat-card { background: white; border-radius: var(--radius); padding: 20px; border: 1px solid var(--border); }
.stat-label { font-size: 13px; color: var(--sub); margin-bottom: 6px; }
.stat-value { font-size: 28px; font-weight: 700; color: var(--line); }

/* Layout */
.content-grid { display: grid; grid-template-columns: 1fr 400px; gap: 20px; }
.main-section { background: white; border-radius: var(--radius); padding: 24px; border: 1px solid var(--border); }
.preview-section { background: white; border-radius: var(--radius); padding: 24px; border: 1px solid var(--border); position: sticky; top: 20px; }

/* Form */
.form-group { margin-bottom: 20px; }
.form-label { display: block; font-size: 13px; font-weight: 600; color: var(--text); margin-bottom: 8px; }
.form-input { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: var(--radius); font-size: 14px; font-family: inherit; }
.form-input:focus { outline: none; border-color: var(--line); }
.form-textarea { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: var(--radius); font-size: 14px; font-family: inherit; min-height: 150px; resize: vertical; }
.form-select { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: var(--radius); font-size: 14px; }

/* Recipient Selector */
.recipient-chips { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
.chip { padding: 6px 12px; background: var(--line); color: white; border-radius: 20px; font-size: 13px; cursor: pointer; border: 2px solid var(--line); transition: all .2s; }
.chip:hover { background: #05a647; border-color: #05a647; }
.chip.outline { background: white; color: var(--line); }
.chip.outline:hover { background: var(--line); color: white; }

/* Template Selector */
.template-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; margin-top: 8px; }
.template-card { padding: 16px; border: 2px solid var(--border); border-radius: var(--radius); cursor: pointer; text-align: center; transition: all .2s; }
.template-card:hover { border-color: var(--line); background: #f0fdf4; }
.template-card.active { border-color: var(--line); background: #d1fae5; }
.template-name { font-size: 13px; font-weight: 500; }

/* Preview */
.preview-title { font-size: 16px; font-weight: 600; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid var(--border); }
.phone-mockup { background: #f9fafb; border-radius: 30px; padding: 50px 20px; border: 10px solid #1a1a2e; box-shadow: 0 4px 24px rgba(0,0,0,0.1); }
.message-bubble { background: var(--line); color: white; padding: 12px 16px; border-radius: 18px; margin-bottom: 12px; font-size: 14px; line-height: 1.6; word-wrap: break-word; }
.message-meta { font-size: 11px; color: var(--sub); text-align: right; margin-top: 4px; }

/* Buttons */
.btn { padding: 12px 24px; border-radius: var(--radius); font-size: 14px; font-weight: 500; cursor: pointer; border: none; font-family: inherit; transition: all .15s; }
.btn-primary { background: var(--line); color: white; }
.btn-primary:hover { background: #05a647; }
.btn-secondary { background: var(--sub); color: white; }
.btn-block { width: 100%; }

/* Config Section */
.config-section { background: #f0fdf4; border: 2px solid var(--line); border-radius: var(--radius); padding: 20px; margin-bottom: 24px; }
.config-title { font-size: 16px; font-weight: 600; color: var(--line); margin-bottom: 16px; }
.config-status { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; margin-left: 10px; }
.config-status.connected { background: #d1fae5; color: #065f46; }
.config-status.disconnected { background: #fee2e2; color: #991b1b; }

/* History Table */
.table-wrap { background: white; border-radius: var(--radius); border: 1px solid var(--border); overflow: hidden; margin-top: 24px; }
.table-wrap table { width: 100%; border-collapse: collapse; }
.table-wrap th { background: #f9fafb; padding: 12px 16px; text-align: left; font-size: 12px; color: var(--sub); font-weight: 600; border-bottom: 1px solid var(--border); }
.table-wrap td { padding: 14px 16px; font-size: 13px; border-bottom: 1px solid #f3f4f6; }
.table-wrap tr:last-child td { border-bottom: none; }
.table-wrap tr:hover td { background: #fafafa; }

.badge { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; }
.badge-sent { background: #d1fae5; color: #065f46; }
.badge-pending { background: #fef3c7; color: #92400e; }
.badge-failed { background: #fee2e2; color: #991b1b; }

@media (max-width: 1200px) {
  .content-grid { grid-template-columns: 1fr; }
  .preview-section { position: static; }
}
</style>
</head>
<body>

<div class="header">
  <h2>LINE 訊息推播</h2>
  <p>發送課程通知、繳費提醒給學生與家長</p>
</div>

<!-- LINE API Configuration -->
<div class="config-section">
  <div class="config-title">
    LINE API 設定
    <span class="config-status" id="lineStatus">未設定</span>
  </div>
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
    <div class="form-group" style="margin-bottom: 0;">
      <label class="form-label">Channel Access Token</label>
      <input class="form-input" type="password" id="accessToken" placeholder="輸入 LINE Channel Access Token">
    </div>
    <div class="form-group" style="margin-bottom: 0;">
      <label class="form-label">Channel Secret</label>
      <input class="form-input" type="password" id="channelSecret" placeholder="輸入 LINE Channel Secret">
    </div>
  </div>
  <button class="btn btn-primary" style="margin-top: 16px;" onclick="saveLineConfig()">儲存設定</button>
  <button class="btn btn-secondary" style="margin-top: 16px; margin-left: 8px;" onclick="testConnection()">測試連線</button>
</div>

<div class="alert" id="configAlert">
  <div class="alert-title">尚未設定 LINE API</div>
  <div class="alert-text">
    請先設定 LINE Channel Access Token 和 Channel Secret 才能發送訊息。<br>
    取得方式：登入 LINE Developers Console > 選擇你的 Channel > Messaging API 分頁
  </div>
</div>

<div class="stats">
  <div class="stat-card">
    <div class="stat-label">本月發送</div>
    <div class="stat-value" id="monthSent">0</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">今日發送</div>
    <div class="stat-value" id="todaySent">0</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">成功率</div>
    <div class="stat-value" id="successRate">100%</div>
  </div>
</div>

<div class="content-grid">
  <!-- Main Form -->
  <div class="main-section">
    <form id="messageForm" onsubmit="sendMessage(event)">
      <div class="form-group">
        <label class="form-label">訊息範本</label>
        <div class="template-grid">
          <div class="template-card active" onclick="selectTemplate('custom')">
            <div class="template-name">自訂訊息</div>
          </div>
          <div class="template-card" onclick="selectTemplate('class')">
            <div class="template-name">上課通知</div>
          </div>
          <div class="template-card" onclick="selectTemplate('payment')">
            <div class="template-name">繳費提醒</div>
          </div>
          <div class="template-card" onclick="selectTemplate('event')">
            <div class="template-name">活動通知</div>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">發送對象</label>
        <div class="recipient-chips">
          <div class="chip" onclick="selectRecipient('all')">全部學生</div>
          <div class="chip outline" onclick="selectRecipient('active')">在學學生</div>
          <div class="chip outline" onclick="selectRecipient('custom')">指定學生</div>
        </div>
        <select class="form-select" id="studentSelect" style="display:none; margin-top:12px;" multiple>
          <option value="1">張小明</option>
          <option value="2">李小華</option>
          <option value="3">王大明</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label">訊息主旨</label>
        <input class="form-input" id="subject" placeholder="例：本週課程提醒" required>
      </div>

      <div class="form-group">
        <label class="form-label">訊息內容</label>
        <textarea class="form-textarea" id="content" placeholder="輸入您要發送的訊息..." required oninput="updatePreview()"></textarea>
        <div style="font-size:12px; color:var(--sub); margin-top:4px;">
          字數：<span id="charCount">0</span> / 500
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">排程發送（選填）</label>
        <input class="form-input" type="datetime-local" id="scheduleTime">
      </div>

      <button type="submit" class="btn btn-primary btn-block">立即發送</button>
    </form>

    <!-- History -->
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>發送時間</th>
            <th>主旨</th>
            <th>對象</th>
            <th>狀態</th>
            <th>成功/總數</th>
          </tr>
        </thead>
        <tbody id="historyTbody">
          <tr>
            <td colspan="5" style="text-align:center; color:var(--sub);">尚無發送記錄</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Preview -->
  <div class="preview-section">
    <div class="preview-title">訊息預覽</div>
    <div class="phone-mockup">
      <div class="message-bubble" id="previewBubble">
        <div id="previewSubject" style="font-weight:600; margin-bottom:8px;">訊息主旨</div>
        <div id="previewContent">訊息內容將顯示在這裡...</div>
        <div class="message-meta">音樂補習班</div>
      </div>
    </div>
  </div>
</div>

<script>
let selectedTemplate = 'custom';
let selectedRecipient = 'all';
let lineConfig = { accessToken: '', channelSecret: '' };

const templates = {
  custom: { subject: '', content: '' },
  class: {
    subject: '本週課程提醒',
    content: '親愛的家長您好：\n\n本週課程安排如下：\n日期：[日期]\n時間：[時間]\n老師：[老師姓名]\n\n請準時到班上課，謝謝！\n\n音樂補習班 敬上'
  },
  payment: {
    subject: '繳費提醒',
    content: '親愛的家長您好：\n\n本月學費尚未繳納，提醒您：\n金額：NT$ [金額]\n繳費期限：[日期]\n\n如已繳費請忽略此訊息，謝謝！\n\n音樂補習班 敬上'
  },
  event: {
    subject: '活動通知',
    content: '親愛的家長您好：\n\n本班將舉辦[活動名稱]：\n時間：[日期時間]\n地點：[地點]\n\n歡迎踴躍參加！\n\n音樂補習班 敬上'
  }
};

// Load LINE Config
function loadLineConfig() {
  const saved = localStorage.getItem('lineConfig');
  if (saved) {
    lineConfig = JSON.parse(saved);
    document.getElementById('accessToken').value = lineConfig.accessToken;
    document.getElementById('channelSecret').value = lineConfig.channelSecret;
    
    if (lineConfig.accessToken && lineConfig.channelSecret) {
      document.getElementById('lineStatus').textContent = '已設定';
      document.getElementById('lineStatus').className = 'config-status connected';
      document.getElementById('configAlert').style.display = 'none';
    }
  }
}

// Save LINE Config
function saveLineConfig() {
  const accessToken = document.getElementById('accessToken').value.trim();
  const channelSecret = document.getElementById('channelSecret').value.trim();
  
  if (!accessToken || !channelSecret) {
    alert('請填寫 Access Token 和 Channel Secret');
    return;
  }
  
  lineConfig = { accessToken, channelSecret };
  localStorage.setItem('lineConfig', JSON.stringify(lineConfig));
  
  document.getElementById('lineStatus').textContent = '已設定';
  document.getElementById('lineStatus').className = 'config-status connected';
  document.getElementById('configAlert').style.display = 'none';
  
  alert('LINE API 設定已儲存！');
}

// Test Connection
async function testConnection() {
  if (!lineConfig.accessToken) {
    alert('請先儲存 LINE API 設定');
    return;
  }
  
  try {
    const response = await fetch('https://api.line.me/v2/bot/info', {
      headers: {
        'Authorization': `Bearer ${lineConfig.accessToken}`
      }
    });
    
    if (response.ok) {
      const data = await response.json();
      alert(`連線成功！\nBot 名稱：${data.displayName}\nBot ID：${data.userId}`);
    } else {
      alert('連線失敗！請檢查 Access Token 是否正確');
    }
  } catch (error) {
    alert('連線錯誤：' + error.message);
  }
}

function selectTemplate(type) {
  selectedTemplate = type;
  document.querySelectorAll('.template-card').forEach(card => card.classList.remove('active'));
  event.target.closest('.template-card').classList.add('active');
  
  const template = templates[type];
  document.getElementById('subject').value = template.subject;
  document.getElementById('content').value = template.content;
  updatePreview();
}

function selectRecipient(type) {
  selectedRecipient = type;
  document.querySelectorAll('.recipient-chips .chip').forEach(chip => {
    chip.classList.remove('outline');
    chip.classList.add('outline');
  });
  event.target.classList.remove('outline');
  
  const studentSelect = document.getElementById('studentSelect');
  studentSelect.style.display = type === 'custom' ? 'block' : 'none';
}

function updatePreview() {
  const subject = document.getElementById('subject').value || '訊息主旨';
  const content = document.getElementById('content').value || '訊息內容將顯示在這裡...';
  
  document.getElementById('previewSubject').textContent = subject;
  document.getElementById('previewContent').textContent = content;
  document.getElementById('charCount').textContent = content.length;
}

async function sendMessage(e) {
  e.preventDefault();
  
  if (!lineConfig.accessToken) {
    alert('請先設定 LINE API！');
    return;
  }
  
  const subject = document.getElementById('subject').value;
  const content = document.getElementById('content').value;
  const scheduleTime = document.getElementById('scheduleTime').value;
  
  const fullMessage = `【${subject}】\n\n${content}`;
  
  if (confirm(`確定要發送訊息給「${selectedRecipient === 'all' ? '全部學生' : selectedRecipient === 'active' ? '在學學生' : '指定學生'}」？`)) {
    try {
      // 實際呼叫後端 API 發送訊息
      const response = await fetch('/admin/api/line/broadcast', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Admin-Password': sessionStorage.getItem('adminPassword') || ''
        },
        body: JSON.stringify({
          access_token: lineConfig.accessToken,
          message: fullMessage,
          recipients: selectedRecipient,
          scheduleTime: scheduleTime
        })
      });
      
      const result = await response.json();
      
      if (response.ok && result.success) {
        // 發送成功
        const now = new Date();
        const timeStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
        
        const tbody = document.getElementById('historyTbody');
        if (tbody.rows[0].cells.length === 1) {
          tbody.innerHTML = '';
        }
        
        const newRow = tbody.insertRow(0);
        newRow.innerHTML = `
          <td>${scheduleTime || timeStr}</td>
          <td>${subject}</td>
          <td>${selectedRecipient === 'all' ? '全部學生' : selectedRecipient === 'active' ? '在學學生' : '指定學生'}</td>
          <td><span class="badge ${scheduleTime ? 'badge-pending' : 'badge-sent'}">${scheduleTime ? '排程中' : '已發送'}</span></td>
          <td>成功</td>
        `;
        
        alert('訊息發送成功！');
        document.getElementById('messageForm').reset();
        updatePreview();
        updateStats();
      } else {
        // 發送失敗
        alert('訊息發送失敗：' + (result.error || '未知錯誤'));
      }
    } catch (error) {
      alert('發送錯誤：' + error.message);
    }
  }
}

function updateStats() {
  const rows = document.getElementById('historyTbody').rows;
  if (rows[0] && rows[0].cells.length === 1) return;
  
  const today = new Date().toISOString().split('T')[0];
  let todayCount = 0;
  
  for (let row of rows) {
    if (row.cells[0].textContent.startsWith(today)) {
      todayCount++;
    }
  }
  
  document.getElementById('monthSent').textContent = rows.length;
  document.getElementById('todaySent').textContent = todayCount;
}

// Init
loadLineConfig();
updatePreview();
updateStats();
</script>

</body>
</html>